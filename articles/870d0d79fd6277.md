---
title: "TypeScriptã§objectã®unionå‹ã‹ã‚‰å‹ã‚’æŠ½å‡ºã™ã‚‹"
emoji: "ğŸ›¡"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["TypeScript"]
published: false
# ã‚¿ã‚¤ãƒˆãƒ«æ¡ˆ1: TypeScriptã§å…±ç”¨ä½“å‹ã®å‹ã‚¬ãƒ¼ãƒ‰ã‚’å‹ãƒ¬ãƒ™ãƒ«ã§å®Ÿç¾ã™ã‚‹
---
## æ¦‚è¦

```ts

type SuccessResult = {
  status: "success"
}

type ErrorResult = {
  status: "error"
  errorCode: number
  errorMessage: string
}

type AbortResult = {
  status: "abort"
}

export type Result = SuccessResult | ErrorResult | AbortResult
```
â†‘ã“ã®ã‚ˆã†ãªå‹ãŒå®šç¾©ã—ã¦ã‚ã£ãŸã¨ã—ã¦

```ts
declare const result: Result

result.errorCode // error! ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ 'errorCode' ã¯å‹ 'Result' ã«å­˜åœ¨ã—ã¾ã›ã‚“ã€‚

if (result.status === "error") {
  // result is ErrorResult
  result.errorCode // ok!
}

```

å‹ã‚¬ãƒ¼ãƒ‰(å…·ä½“çš„ã«ã¯[Discriminated unions](https://www.typescriptlang.org/docs/handbook/2/narrowing.html#discriminated-unions))ã«ã‚ˆã£ã¦ã€`result.status === "error"`ã®æ™‚`result`ã¯`ErrorResult`å‹ã¨ã—ã¦æ‰±ã†ã“ã¨ãŒã§ãã¾ã™ã€‚

ã—ã‹ã—ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®tsã®å‹æ©Ÿèƒ½ã ã‘ã§`Result`å‹ã®ã‚ˆã†ãªunionå‹ã‹ã‚‰ç‰¹å®šã®å‹ã‚’æŠ½å‡ºã™ã‚‹ã“ã¨ã¯ã§ãã¾ã›ã‚“ã€‚

ãã“ã§ã€

- objectã®unionå‹
- keyã¨ãªã‚‹ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£å(string literalå‹)
- ç‰¹å®šã®ã®keyã¨ä¸€è‡´ã™ã‚‹åç§°(string literalå‹)

ä¸Šè¨˜ã®3ã¤ã®å‹ã‚’æŒ‡å®šã—ã¦ã€unionå‹ã‹ã‚‰ç‰¹å®šã®å‹ã‚’æŠ½å‡ºã™ã‚‹å‹ãƒãƒƒã‚¯ã‚’å®Ÿè£…ã—ã¾ã™ã€‚

## å®Ÿè£…

ts 4.5.4 ã§ç¢ºèªã—ã¦ã„ã¾ã™ã€‚([å…¨ä½“ã®ã‚½ãƒ¼ã‚¹ã®ãƒ—ãƒ¬ã‚¤ã‚°ãƒ©ãƒ³ãƒ‰](https://www.typescriptlang.org/ja/play?#code/C4TwDgpgBAYglgOwCYwE4HsC2BVBd0IA8AUFFACoCGqA5hMFBAB7ATIDOUA3gL4A0pKAGkIIAAoYwjFmyScA1qPQAzCtTrABZESGmsOa2vQDaOiejABdYgD4oAXkMa9szlyjGmURMNHmrAFy+ujxQAPxO9FBBCBAAbhCoxMQA9ClQoJCwiCgYOHgEJGlkkQzM+nLc-Knp2n6SLgaKICqlAsV1uuWupab1FtbFdo4AoiyolADGwIRURppQAEoQk+ioSIRmknzBNjbJmdAAygCuk5MQ7OzL7CcANgyOXILswJTAJ+xBAES355fsb7EHgHcDQEaoDCoG73R7cF5vD5fKDfRJQoFkNFrADC6CQEBiJ0wACNEoIsagALIAyh0IKvVCIGjA0FZACCxLWwBhDwc8LIr3enx+lE5qGAQJBxEOS0usL5p3+Vx5DAAPlAIVCVVB1RyuSrWdAVZTKFInoJjCqjojPt4ELLbg9jL8bYDLJYgvBkGgsLh8EQVTsXULATsra79lKUgAqYjG01854Cs4XK5BRWp65yh4AbnJkLWQU1axVebIoq5QT14tLLOjKUNDthMBOCEmJrN-I84ZDdqbTuDSO+7rCQQAFKhs8BPTkffl-YRAyjBUOw1PrSGbABKBx2OLoOBIFkxuNTlttjuJl4pgGjqBjidT9M35VTnf2PcHpA79Wt-HKRAICQMtGALVA7wfSdHWnDUwJVd9P0PH8oD-CAANiYDBArcUIMfaCqzFbk313KB9yQnUUOQNDAMwkF62SZRW2mf0oEmSd3ggFUAAlKGQO5EjHAALXikH4qlTSCFVz3bU0t3HAB9STiI-Uivy7ScPlQe08NhBCuzIYpAFqGQBjhkAToZAAmGQB1BkAKwZABEGQALBkACoZAEuGQAfhkAawZrMAaIZBDIVYEFeKBGLbPlhL4xIO2MKDYQAOhXT5LCgShOAfRT+2APSyO-CjUPQoDfKCpiwhinSHi3QQQSlfzArC0TEj5NiIA47iRLEsckygP5MzHHcOr8gh2HQfiYrudAaDHb5JmS6AuoBb5yrIapMTA9rQKhXF8R2ClqSuWloB4XqCuKQBEwigQBUfUAB1NADsGQBo9UAGQZAEMGQBghkAZIZ7IAA2LaEp3em7AGkGQBIhkACuNABo7QBVBkAGIZADMGWyfJKViBqGiARrGiapvYaAKW+HZ3ApDaIC2sCdvYPaoAOiqtCSwiev0hGAqRlHxsm6aqa5eaKeBcriFqtqOvi5FfhfUNOZqKBACTCViWdmq5kh5gS+ddH4scpvG8QJKAABYAAYAEYVaJmk6RRXBKBOYBBLWOAAC8gOxkXigl9HMbA7g1pxNWgm1vW3apQ31YAchNs2LcZG2kH9snZda+WERDEVCLt8mHcljHWfFYggA))

```ts
type FindFromUnion<
  Target extends {},
  KeyProp extends keyof Target,
  Key extends Target[KeyProp]
> = Target extends { [x in KeyProp]: Key } ? Target : never;
```

:::details åˆ¥ã®æ›¸ãæ–¹

```ts
type FindFromUnion<
  Target extends {},
  KeyProp extends keyof Target,
  Key extends Target[KeyProp]
> = Extract<Target, Record<KeyProp, Key>>
```

:::


```ts
type ErrorResult2 = FindFromUnion<Result, "status", "error">
// ErrorResult2 is ErrorResult
```

`FindFromUnion<Result, "status", "error">`ã¨æ›¸ãã“ã¨ã§ã€`Result`å‹ã‹ã‚‰`ErrorResult`å‹ã‚’æŠ½å‡ºã™ã‚‹ã“ã¨ãŒã§ãã¾ã—ãŸã€‚



## ã„ã¤ã“ã‚ŒãŒå½¹ã«ç«‹ã¤ã®ã‹

ä¸Šè¨˜ã®ã‚ˆã†ãªã‚ˆã†ãªä½¿ã„æ–¹ã¯å…ƒã®`ErrorResult`å‹ã‚’exportã™ã‚Œã°è§£æ±ºã™ã‚‹ã®ã§ã‚ã¾ã‚Šã—ãªã„ã¨æ€ã„ã¾ã™ã€‚

ã„ã¤`FindFromUnion`å‹ãŒå½¹ã«ç«‹ã¤ã‹ã¨ã„ã†ã¨ã€[Mapped types](https://www.typescriptlang.org/docs/handbook/2/mapped-types.html)ã‚’ä½¿ã£ã¦å‹ã‚’å‹•çš„ã«ä½œã‚‹ã¨ãã«å½¹ã«ç«‹ã¡ã¾ã™ã€‚

:::details Mapped typesã«ã¤ã„ã¦è§£èª¬

```ts
// Result["status"] = "success" | "error" | "abort"
type ResultMap = {
  [ResultStatus in Result["status"]]: ResultStatus
}
/*
ResultMap is {
  success: "success";
  error: "error";
  abort: "abort";
}
*/
```

æœ€åˆã«å‡ºã¦ããŸ`Result`å‹ã‚’ä½¿ã£ã¦ã€ä¸Šè¨˜ã®ã‚ˆã†ãª`ResultMap`å‹ãŒä½œã‚Œã¾ã™ã€‚
ãƒã‚¤ãƒ³ãƒˆã¯ã€`ResultStatus`ãŒãã‚Œãã‚Œã€`"success"`å‹ã€`"error"`å‹ã€`"abort"`å‹ã«ãªã‚‹ã“ã¨ã§ã™ã€‚

ã“ã‚Œã«`FindFromUnion`å‹ã‚’ä½¿ã†ã¨ã€

```ts
type ResultMap = {
  [ResultStatus in Result["status"]]: FindFromUnion<Result, "status", ResultStatus>
}
/*
ResultMap is {
  success: SuccessResult;
  error: ErrorResult;
  abort: AbortResult;
}
*/
```

ã“ã®ã‚ˆã†ã«ã€unionå‹ã®objectã‹ã‚‰ã€`Result["status"]`ã‚’keyã¨ã—ãŸåˆ¥ã®å‹ãŒä½œã‚Œã¾ã™ã€‚

ã‚‚ã¡ã‚ã‚“ã€ã‚ªãƒ—ã‚·ãƒ§ãƒŠãƒ«ã‚„é–¢æ•°ã«ã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™

```ts
type ResultFuncMap = {
  [ResultStatus in Result["status"]]?: (result: FindFromUnion<Result, "status", ResultStatus>) => void
}
/*
ResultFuncMap = {
  success?: ((result: SuccessResult) => void) | undefined;
  error?: ((result: ErrorResult) => void) | undefined;
  abort?: ((result: AbortResult) => void) | undefined;
}
*/
```

:::

ä»¥ä¸‹ã®ä¾‹ã§ã¯ã€Mapped typesã‚’ä½¿ç”¨ã—ã¦`ResultFuncMap`å‹ã‚’å®šç¾©ã—ã€`createResultHandler`é–¢æ•°ã‚’å®Ÿè£…ã™ã‚‹ã“ã¨ã§ã€ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒãƒƒãƒã®ã‚ˆã†ãªãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°ã‚’å‹å®‰å…¨ã«å®Ÿè£…ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚


```ts
type ResultFuncMap = {
  [ResultStatus in Result["status"]]?: (result: FindFromUnion<Result, "status", ResultStatus>) => void
}
/*
ResultFuncMap = {
  success?: ((result: SuccessResult) => void) | undefined;
  error?: ((result: ErrorResult) => void) | undefined;
  abort?: ((result: AbortResult) => void) | undefined;
}
*/

function createResultHandler(handlerMap: ResultFuncMap): (_: Result) => void {
  return (result) => {
    // ã‚­ãƒ£ã‚¹ãƒˆã—ãªã„ã¨ã‚¨ãƒ©ãƒ¼ã«ãªã‚‹
    const func = handlerMap[result.status] as ((_: Result) => void) | undefined
    func?.(result)
  }
}

const handler = createResultHandler({
  success() {
    console.log("case success")
  },
  error({ errorCode, errorMessage }) {
    // â†‘ å¼•æ•°ã®å‹ãŒã¡ã‚ƒã‚“ã¨`ErrorResult`å‹ã‹ã‚‰æ¨æ¸¬ã•ã‚Œã¦ã„ã‚‹
    console.log("case error", { errorCode, errorMessage })
  },
  abort() {
    console.log("case abort")
  },
})

handler({
  status: "success",
})
// â†’ case success

handler({
  status: "error",
  errorCode: 401,
  errorMessage: "Unauthorized",
})
// â†’ case error { errorCode: 401, errorMessage: 'Unauthorized' }

handler({
  status: "abort",
})
// â†’ case abort

```

:::details è£œè¶³

```ts
function createResultHandler(handlerMap: ResultFuncMap): (_: Result) => void {
  return (result) => {
    // ã‚­ãƒ£ã‚¹ãƒˆã—ãªã„ã¨ã‚¨ãƒ©ãƒ¼ã«ãªã‚‹
    const func = handlerMap[result.status] as ((_: Result) => void) | undefined
    func?.(result)
  }
}
```

ä¸Šè¨˜ã®ç®‡æ‰€ã¯ã‚­ãƒ£ã‚¹ãƒˆã—ãªã„ã¨ã‚¨ãƒ©ãƒ¼ã«ãªã‚Šã¾ã™ã€‚
![](https://storage.googleapis.com/zenn-user-upload/42ca9de641d0-20220209.png)

:::


`FindFromUnion`å‹ã‚’ä½¿ã†æ©Ÿä¼šã¯ã‚ã¾ã‚Šãªã•ãã†ã§ã™ãŒã€Mapped typesã¨åˆã‚ã›ã¦ä½¿ã†ã¨ã¨ã¦ã‚‚å¼·åŠ›ãªã®ã§æ˜¯éä½¿ã£ã¦ã¿ã¦ãã ã•ã„ï¼
